from typing import Union

import torch
from torch import Tensor, nn
from torchvision.models import ResNet, ResNet50_Weights, resnet50

from torchdistill.models.registry import register_model_func


class TorchvisionResNetWrapper(nn.Module):
    def __init__(self, model: ResNet):
        super().__init__()
        self.layers = nn.Sequential(
            model.conv1,
            model.bn1,
            model.relu,
            model.maxpool,
            *list(model.layer1),
            *list(model.layer2),
            *list(model.layer3),
            *list(model.layer4),
            model.avgpool,
            nn.Flatten(),
            model.fc,
        )
        del model

    def forward(self, x: Tensor) -> Tensor:
        x = self.layers(x)
        return x


@register_model_func
def get_pruned_resnet50(
    pretrained: bool = True, prune_idx: Union[int, str] = 0, *args, **kwargs
):
    if prune_idx == "stem":
        prune_idx = 4
    weights = ResNet50_Weights.IMAGENET1K_V1 if pretrained else None
    resnet = resnet50(weights=weights)
    resnet = TorchvisionResNetWrapper(resnet)
    resnet.layers = resnet.layers[:prune_idx]
    return resnet


if __name__ == "__main__":
    model = TorchvisionResNetWrapper(resnet50())
    model_pr0 = get_pruned_resnet50(prune_idx=0)
    assert len(model_pr0.layers) == 0
    model_pr10 = get_pruned_resnet50(prune_idx=10)
    assert len(model_pr10.layers) == 10
    from torchinfo import summary

    summary(
        model,
        (1, 3, 224, 224),
        col_names=[
            "input_size",
            "output_size",
            "num_params",
            "input_size",
            "output_size",
        ],
        depth=3,
    )
    """
TorchvisionResNetWrapper                 [1, 3, 224, 224]          [1, 1000]                 --                        [1, 3, 224, 224]          [1, 1000]
├─Sequential: 1-1                        [1, 3, 224, 224]          [1, 1000]                 --                        [1, 3, 224, 224]          [1, 1000]
│    └─Conv2d: 2-1                       [1, 3, 224, 224]          [1, 64, 112, 112]         9,408                     [1, 3, 224, 224]          [1, 64, 112, 112]
│    └─BatchNorm2d: 2-2                  [1, 64, 112, 112]         [1, 64, 112, 112]         128                       [1, 64, 112, 112]         [1, 64, 112, 112]
│    └─ReLU: 2-3                         [1, 64, 112, 112]         [1, 64, 112, 112]         --                        [1, 64, 112, 112]         [1, 64, 112, 112]
│    └─MaxPool2d: 2-4                    [1, 64, 112, 112]         [1, 64, 56, 56]           --                        [1, 64, 112, 112]         [1, 64, 56, 56]
 ======Stem [Prune_idx=4]=======
│    └─Bottleneck: 2-5                   [1, 64, 56, 56]           [1, 256, 56, 56]          75,008                    [1, 64, 56, 56]           [1, 256, 56, 56]
│    └─Bottleneck: 2-6                   [1, 256, 56, 56]          [1, 256, 56, 56]          70,400                    [1, 256, 56, 56]          [1, 256, 56, 56]
│    └─Bottleneck: 2-7                   [1, 256, 56, 56]          [1, 256, 56, 56]          70,400                    [1, 256, 56, 56]          [1, 256, 56, 56]
     ======Block 1 [Prune_idx=7]=======
│    └─Bottleneck: 2-8                   [1, 256, 56, 56]          [1, 512, 28, 28]          379,392                   [1, 256, 56, 56]          [1, 512, 28, 28]
│    └─Bottleneck: 2-9                   [1, 512, 28, 28]          [1, 512, 28, 28]          280,064                   [1, 512, 28, 28]          [1, 512, 28, 28]
│    └─Bottleneck: 2-10                  [1, 512, 28, 28]          [1, 512, 28, 28]          280,064                   [1, 512, 28, 28]          [1, 512, 28, 28]
│    └─Bottleneck: 2-11                  [1, 512, 28, 28]          [1, 512, 28, 28]          280,064                   [1, 512, 28, 28]          [1, 512, 28, 28]
    ======Block 2 [Prune_idx=11]=======
│    └─Bottleneck: 2-12                  [1, 512, 28, 28]          [1, 1024, 14, 14]         1,512,448                 [1, 512, 28, 28]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-13                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         1,117,184                 [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    └─Bottleneck: 2-14                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         1,117,184                 [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    └─Bottleneck: 2-15                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         1,117,184                 [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    └─Bottleneck: 2-16                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         1,117,184                 [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    └─Bottleneck: 2-17                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         1,117,184                 [1, 1024, 14, 14]         [1, 1024, 14, 14]
    ======Block 3 [Prune_idx=17]=======
│    └─Bottleneck: 2-18                  [1, 1024, 14, 14]         [1, 2048, 7, 7]           6,039,552                 [1, 1024, 14, 14]         [1, 2048, 7, 7]
│    └─Bottleneck: 2-19                  [1, 2048, 7, 7]           [1, 2048, 7, 7]           4,462,592                 [1, 2048, 7, 7]           [1, 2048, 7, 7]
│    └─Bottleneck: 2-20                  [1, 2048, 7, 7]           [1, 2048, 7, 7]           4,462,592                 [1, 2048, 7, 7]           [1, 2048, 7, 7]
    ======Block 4 [Prune_idx=20]=======
│    └─AdaptiveAvgPool2d: 2-21           [1, 2048, 7, 7]           [1, 2048, 1, 1]           --                        [1, 2048, 7, 7]           [1, 2048, 1, 1]
│    └─Flatten: 2-22                     [1, 2048, 1, 1]           [1, 2048]                 --                        [1, 2048, 1, 1]           [1, 2048]
│    └─Linear: 2-23                      [1, 2048]                 [1, 1000]                 2,049,000                 [1, 2048]                 [1, 1000]
    """


"""
│    └─Bottleneck: 2-5                   [1, 64, 56, 56]           [1, 256, 56, 56]          --                        [1, 64, 56, 56]           [1, 256, 56, 56]
│    │    └─Conv2d: 3-1                  [1, 64, 56, 56]           [1, 64, 56, 56]           4,096                     [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-2             [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-3                    [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-4                  [1, 64, 56, 56]           [1, 64, 56, 56]           36,864                    [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-5             [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-6                    [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-7                  [1, 64, 56, 56]           [1, 256, 56, 56]          16,384                    [1, 64, 56, 56]           [1, 256, 56, 56]
│    │    └─BatchNorm2d: 3-8             [1, 256, 56, 56]          [1, 256, 56, 56]          512                       [1, 256, 56, 56]          [1, 256, 56, 56]
│    │    └─Sequential: 3-9              [1, 64, 56, 56]           [1, 256, 56, 56]          16,896                    [1, 64, 56, 56]           [1, 256, 56, 56]
│    │    └─ReLU: 3-10                   [1, 256, 56, 56]          [1, 256, 56, 56]          --                        [1, 256, 56, 56]          [1, 256, 56, 56]
│    └─Bottleneck: 2-6                   [1, 256, 56, 56]          [1, 256, 56, 56]          --                        [1, 256, 56, 56]          [1, 256, 56, 56]
│    │    └─Conv2d: 3-11                 [1, 256, 56, 56]          [1, 64, 56, 56]           16,384                    [1, 256, 56, 56]          [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-12            [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-13                   [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-14                 [1, 64, 56, 56]           [1, 64, 56, 56]           36,864                    [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-15            [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-16                   [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-17                 [1, 64, 56, 56]           [1, 256, 56, 56]          16,384                    [1, 64, 56, 56]           [1, 256, 56, 56]
│    │    └─BatchNorm2d: 3-18            [1, 256, 56, 56]          [1, 256, 56, 56]          512                       [1, 256, 56, 56]          [1, 256, 56, 56]
│    │    └─ReLU: 3-19                   [1, 256, 56, 56]          [1, 256, 56, 56]          --                        [1, 256, 56, 56]          [1, 256, 56, 56]
│    └─Bottleneck: 2-7                   [1, 256, 56, 56]          [1, 256, 56, 56]          --                        [1, 256, 56, 56]          [1, 256, 56, 56]
│    │    └─Conv2d: 3-20                 [1, 256, 56, 56]          [1, 64, 56, 56]           16,384                    [1, 256, 56, 56]          [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-21            [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-22                   [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-23                 [1, 64, 56, 56]           [1, 64, 56, 56]           36,864                    [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─BatchNorm2d: 3-24            [1, 64, 56, 56]           [1, 64, 56, 56]           128                       [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─ReLU: 3-25                   [1, 64, 56, 56]           [1, 64, 56, 56]           --                        [1, 64, 56, 56]           [1, 64, 56, 56]
│    │    └─Conv2d: 3-26                 [1, 64, 56, 56]           [1, 256, 56, 56]          16,384                    [1, 64, 56, 56]           [1, 256, 56, 56]
│    │    └─BatchNorm2d: 3-27            [1, 256, 56, 56]          [1, 256, 56, 56]          512                       [1, 256, 56, 56]          [1, 256, 56, 56]
│    │    └─ReLU: 3-28                   [1, 256, 56, 56]          [1, 256, 56, 56]          --                        [1, 256, 56, 56]          [1, 256, 56, 56]
---------------------------------------------------------------------------------------Stage 1------------------------------------------------------------------------
│    └─Bottleneck: 2-8                             --                        
│    │    └─Conv2d: 3-29                 [1, 256, 56, 56]          [1, 128, 56, 56]          32,768                    [1, 256, 56, 56]          [1, 128, 56, 56]
│    │    └─Conv2d: 3-32                 [1, 128, 56, 56]          [1, 128, 28, 28]          147,456                   [1, 128, 56, 56]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-35                 [1, 128, 28, 28]          [1, 512, 28, 28]          65,536                    [1, 128, 28, 28]          [1, 512, 28, 28]
│    └─Bottleneck: 2-9                   [1, 512, 28, 28]          [1, 512, 28, 28]          --                        [1, 512, 28, 28]          [1, 512, 28, 28]
│    │    └─Conv2d: 3-39                 [1, 512, 28, 28]          [1, 128, 28, 28]          65,536                    [1, 512, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-42                 [1, 128, 28, 28]          [1, 128, 28, 28]          147,456                   [1, 128, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-45                 [1, 128, 28, 28]          [1, 512, 28, 28]          65,536                    [1, 128, 28, 28]          [1, 512, 28, 28]
│    └─Bottleneck: 2-10                  [1, 512, 28, 28]          [1, 512, 28, 28]          --                        [1, 512, 28, 28]          [1, 512, 28, 28]
│    │    └─Conv2d: 3-48                 [1, 512, 28, 28]          [1, 128, 28, 28]          65,536                    [1, 512, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-51                 [1, 128, 28, 28]          [1, 128, 28, 28]          147,456                   [1, 128, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-54                 [1, 128, 28, 28]          [1, 512, 28, 28]          65,536                    [1, 128, 28, 28]          [1, 512, 28, 28]
│    └─Bottleneck: 2-11                  [1, 512, 28, 28]          [1, 512, 28, 28]          --                        [1, 512, 28, 28]          [1, 512, 28, 28]
│    │    └─Conv2d: 3-57                 [1, 512, 28, 28]          [1, 128, 28, 28]          65,536                    [1, 512, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-60                 [1, 128, 28, 28]          [1, 128, 28, 28]          147,456                   [1, 128, 28, 28]          [1, 128, 28, 28]
│    │    └─Conv2d: 3-63                 [1, 128, 28, 28]          [1, 512, 28, 28]          65,536                    [1, 128, 28, 28]          [1, 512, 28, 28]
---------------------------------------------------------------------------------------Stage 2------------------------------------------------------------------------
│    └─Bottleneck: 2-12                  [1, 512, 28, 28]          [1, 1024, 14, 14]         --                        [1, 512, 28, 28]          [1, 1024, 14, 14]
│    │    └─Conv2d: 3-66                 [1, 512, 28, 28]          [1, 256, 28, 28]          131,072                   [1, 512, 28, 28]          [1, 256, 28, 28]
│    │    └─Conv2d: 3-69                 [1, 256, 28, 28]          [1, 256, 14, 14]          589,824                   [1, 256, 28, 28]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-72                 [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-13                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         --                        [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    │    └─Conv2d: 3-76                 [1, 1024, 14, 14]         [1, 256, 14, 14]          262,144                   [1, 1024, 14, 14]         [1, 256, 14, 14]
│    │    └─Conv2d: 3-79                 [1, 256, 14, 14]          [1, 256, 14, 14]          589,824                   [1, 256, 14, 14]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-82                 [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-14                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         --                        [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    │    └─Conv2d: 3-85                 [1, 1024, 14, 14]         [1, 256, 14, 14]          262,144                   [1, 1024, 14, 14]         [1, 256, 14, 14]
│    │    └─Conv2d: 3-88                 [1, 256, 14, 14]          [1, 256, 14, 14]          589,824                   [1, 256, 14, 14]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-91                 [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-15                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         --                        [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    │    └─Conv2d: 3-94                 [1, 1024, 14, 14]         [1, 256, 14, 14]          262,144                   [1, 1024, 14, 14]         [1, 256, 14, 14]
│    │    └─Conv2d: 3-97                 [1, 256, 14, 14]          [1, 256, 14, 14]          589,824                   [1, 256, 14, 14]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-100                [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-16                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         --                        [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    │    └─Conv2d: 3-103                [1, 1024, 14, 14]         [1, 256, 14, 14]          262,144                   [1, 1024, 14, 14]         [1, 256, 14, 14]
│    │    └─Conv2d: 3-106                [1, 256, 14, 14]          [1, 256, 14, 14]          589,824                   [1, 256, 14, 14]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-109                [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
│    └─Bottleneck: 2-17                  [1, 1024, 14, 14]         [1, 1024, 14, 14]         --                        [1, 1024, 14, 14]         [1, 1024, 14, 14]
│    │    └─Conv2d: 3-112                [1, 1024, 14, 14]         [1, 256, 14, 14]          262,144                   [1, 1024, 14, 14]         [1, 256, 14, 14]
│    │    └─Conv2d: 3-115                [1, 256, 14, 14]          [1, 256, 14, 14]          589,824                   [1, 256, 14, 14]          [1, 256, 14, 14]
│    │    └─Conv2d: 3-118                [1, 256, 14, 14]          [1, 1024, 14, 14]         262,144                   [1, 256, 14, 14]          [1, 1024, 14, 14]
---------------------------------------------------------------------------------------Stage 3------------------------------------------------------------------------
│    └─Bottleneck: 2-18                  [1, 1024, 14, 14]         [1, 2048, 7, 7]           --                        [1, 1024, 14, 14]         [1, 2048, 7, 7]
│    │    └─Conv2d: 3-121                [1, 1024, 14, 14]         [1, 512, 14, 14]          524,288                   [1, 1024, 14, 14]         [1, 512, 14, 14]
│    │    └─Conv2d: 3-124                [1, 512, 14, 14]          [1, 512, 7, 7]            2,359,296                 [1, 512, 14, 14]          [1, 512, 7, 7]
│    │    └─Conv2d: 3-127                [1, 512, 7, 7]            [1, 2048, 7, 7]           1,048,576                 [1, 512, 7, 7]            [1, 2048, 7, 7]
│    └─Bottleneck: 2-19                  [1, 2048, 7, 7]           [1, 2048, 7, 7]           --                        [1, 2048, 7, 7]           [1, 2048, 7, 7]
│    │    └─Conv2d: 3-131                [1, 2048, 7, 7]           [1, 512, 7, 7]            1,048,576                 [1, 2048, 7, 7]           [1, 512, 7, 7]
│    │    └─Conv2d: 3-134                [1, 512, 7, 7]            [1, 512, 7, 7]            2,359,296                 [1, 512, 7, 7]            [1, 512, 7, 7]
│    │    └─Conv2d: 3-137                [1, 512, 7, 7]            [1, 2048, 7, 7]           1,048,576                 [1, 512, 7, 7]            [1, 2048, 7, 7]
│    └─Bottleneck: 2-20                  [1, 2048, 7, 7]           [1, 2048, 7, 7]           --                        [1, 2048, 7, 7]           [1, 2048, 7, 7]
│    │    └─Conv2d: 3-140                [1, 2048, 7, 7]           [1, 512, 7, 7]            1,048,576                 [1, 2048, 7, 7]           [1, 512, 7, 7]
│    │    └─Conv2d: 3-143                [1, 512, 7, 7]            [1, 512, 7, 7]            2,359,296                 [1, 512, 7, 7]            [1, 512, 7, 7]
│    │    └─Conv2d: 3-146                [1, 512, 7, 7]            [1, 2048, 7, 7]           1,048,576                 [1, 512, 7, 7]            [1, 2048, 7, 7]
---------------------------------------------------------------------------------------Stage 4------------------------------------------------------------------------
│    └─AdaptiveAvgPool2d: 2-21           [1, 2048, 7, 7]           [1, 2048, 1, 1]           --                        [1, 2048, 7, 7]           [1, 2048, 1, 1]
│    └─Flatten: 2-22                     [1, 2048, 1, 1]           [1, 2048]                 --                        [1, 2048, 1, 1]           [1, 2048]
│    └─Linear: 2-23                      [1, 2048]                 [1, 1000]                 2,049,000                 [1, 2048]                 [1, 1000]
"""